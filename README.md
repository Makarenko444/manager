# manager

Система для менеджеров интернет провайдера.

## Главная страница

В корне проекта находятся статические файлы `index.html` и `styles.css` с макетом главной страницы сервиса manager.tomica.ru.

### Пошаговый локальный просмотр

1. Убедитесь, что на компьютере установлен Python 3.
2. Перейдите в каталог проекта:
   ```bash
   cd manager
   ```
3. Запустите встроенный статический сервер Python:
   ```bash
   python -m http.server 8000
   ```
4. Откройте браузер и перейдите по адресу <http://localhost:8000/index.html>.
5. Остановите сервер сочетанием `Ctrl+C`, когда просмотр будет завершён.

## Публикация на сервере

Ниже описаны два варианта: через Docker и через синхронизацию статических файлов. Выберите тот, который удобнее в вашей инфраструктуре. Для полноценной настройки Nginx под доменное имя смотрите раздел [Настройка Nginx](#настройка-nginx).

### Вариант 1. Развертывание в Docker

1. **Подготовьте сервер.** Убедитесь, что на нём установлены Docker и Docker Compose v2.
2. **Запустите демона Docker.** Проверьте его состояние и, при необходимости, включите службу:
   ```bash
   sudo systemctl status docker
   sudo systemctl start docker   # если служба не запущена
   ```
   > Если команда `docker compose up` возвращает `Cannot connect to the Docker daemon`, значит демон не запущен или нет прав на доступ к сокету. Запустите службу и повторите команду.
3. **Скопируйте проект.** Передайте каталог `manager` на сервер с помощью `git clone`, `scp` или `rsync`.
4. **Перейдите в папку проекта** на сервере:
   ```bash
   cd /path/to/manager
   ```
5. **Соберите и запустите контейнер.** Выполните команду прямо из каталога проекта или укажите путь к файлу:
   ```bash
   docker compose -f docker-compose.yml up -d --build
   ```
   > Если появилось сообщение `no configuration file provided: not found`, значит Compose не увидел файл `docker-compose.yml`.
   > Проверьте, что вы находитесь в каталоге проекта (`pwd`, `ls`) или добавьте абсолютный путь, например
   > `docker compose -f /path/to/manager/docker-compose.yml up -d --build`.
6. **Проверьте, что контейнер работает:**
   ```bash
   docker compose ps
   ```
7. **Настройте проксирование.** По умолчанию Nginx в контейнере слушает порт 80 и проброшен на 8080 хоста. Настройте брандмауэр и, при необходимости, внешний веб-сервер (например, основной Nginx на хосте), чтобы проксировать запросы на контейнер.
8. **Проверьте сайт.** Перейдите в браузере по адресу `http://<ваш_сервер>:8080` или по доменному имени, если настроен прокси.

### Вариант 2. Статический хостинг через rsync

1. **Установите переменные окружения с данными сервера** (можно добавить их в `~/.bashrc`):
   ```bash
   export SERVER_HOST=example.com
   export SERVER_USER=deploy
   export SERVER_PATH=/var/www/manager
   ```
2. **Убедитесь, что на сервере есть каталог назначения.** При необходимости создайте его и назначьте права:
   ```bash
   ssh ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH} && chmod 755 ${SERVER_PATH}"
   ```
3. **Запустите скрипт деплоя из корня проекта:**
   ```bash
   ./deploy.sh
   ```
4. **Настройте веб-сервер на стороне хоста.** Укажите веб-серверу (например, Nginx или Apache) отдавать статические файлы из `${SERVER_PATH}`. Типовая конфигурация Nginx:
   ```nginx
   server {
       listen 80;
       server_name manager.tomica.ru;

       root ${SERVER_PATH};
       index index.html;

       location / {
           try_files $uri $uri/ =404;
       }
   }
   ```
5. **Проверьте публикацию.** Перейдите по доменному имени `manager.tomica.ru` и убедитесь, что загружается обновлённая версия страницы.

Скрипт `deploy.sh` использует `rsync` и синхронизирует файлы `index.html`, `styles.css`, `Dockerfile` и `docker-compose.yml` с указанной директорией на сервере. При повторном запуске он удалит устаревшие файлы, которых нет в репозитории.

## Настройка Nginx

Чтобы автоматизировать подготовку сервера и выпуск сайта по домену `manager.tomica.ru`, воспользуйтесь скриптом `configure_server.sh`. Он устанавливает Nginx (через `apt` или `yum`), создаёт директорию публикации и загружает конфигурацию виртуального хоста.

1. **Подготовьте переменные окружения:**
   ```bash
   export SERVER_HOST=manager.tomica.ru   # адрес сервера
   export SERVER_USER=deploy              # пользователь с доступом по SSH и sudo
   export SERVER_PATH=/var/www/manager    # директория для статических файлов
   export SERVER_DOMAIN=manager.tomica.ru # доменное имя
   ```
2. **Разрешите sudo без пароля для команд установки/перезапуска Nginx**, либо заранее войдите под пользователем с правами root.
3. **Запустите скрипт настройки:**
   ```bash
   ./configure_server.sh
   ```
4. **Проверьте конфигурацию.** Скрипт выполнит `nginx -t` и перезапустит службу. После завершения убедитесь, что сайт доступен по HTTPS/HTTP.

Файл конфигурации создаётся на основе шаблона `config/nginx/site.conf.template`. При необходимости адаптируйте его (например, добавьте редирект на HTTPS или прокси на backend-сервис).
